<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Todo</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'><rect width='32' height='32' rx='8' fill='%231a1614'/><text x='50%25' y='54%25' font-size='18' text-anchor='middle' dominant-baseline='middle'>âœ“</text></svg>">
<link href="https://fonts.googleapis.com/css2?family=Instrument+Serif:ital@0;1&family=DM+Mono:wght@300;400&display=swap" rel="stylesheet">
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --bg: #111110;
  --surface: #1a1917;
  --surface2: #222120;
  --surface3: #2a2826;
  --border: #2a2826;
  --border-h: #3a3835;
  --text: #e8e4df;
  --muted: #6b6560;
  --dim: #3a3632;
  --accent: #e8c87a;
  --accent-d: rgba(232,200,122,0.1);
  --green: #6dbd7a;
  --green-d: rgba(109,189,122,0.1);
  --red: #e07a6d;
  --red-d: rgba(224,122,109,0.1);
  --blue: #7ab8e0;
  --blue-d: rgba(122,184,224,0.1);
}

body { background:var(--bg); color:var(--text); font-family:'DM Mono',monospace; font-weight:300; min-height:100vh; overflow-x:hidden; }

/* Header */
.header { display:flex; align-items:center; justify-content:space-between; padding:28px 28px 0; margin-bottom:20px; opacity:0; animation:fadeUp .5s ease forwards; }
.title { font-family:'Instrument Serif',serif; font-size:28px; font-weight:400; letter-spacing:-.02em; }
.title em { font-style:italic; color:var(--accent); }
.header-right { display:flex; align-items:center; gap:8px; }

.icon-btn { width:36px; height:36px; border-radius:9px; border:1px solid var(--border); background:var(--surface); color:var(--muted); cursor:pointer; display:flex; align-items:center; justify-content:center; font-size:15px; transition:all .15s; }
.icon-btn:hover { border-color:var(--border-h); color:var(--text); }

.view-toggle { display:flex; background:var(--surface); border:1px solid var(--border); border-radius:8px; overflow:hidden; }
.view-btn { padding:6px 12px; border:none; background:transparent; color:var(--muted); font-family:'DM Mono',monospace; font-size:11px; cursor:pointer; transition:all .15s; }
.view-btn.active { background:var(--surface2); color:var(--text); }

/* Add form */
.add-form { background:var(--surface); border:1px solid var(--border); border-radius:12px; padding:16px 20px; margin:0 28px 20px; opacity:0; animation:fadeUp .5s ease .1s forwards; }
.add-input-row { display:flex; gap:8px; margin-bottom:12px; }
.add-input { flex:1; background:var(--surface2); border:1px solid var(--border); border-radius:8px; padding:10px 14px; color:var(--text); font-family:'DM Mono',monospace; font-size:13px; font-weight:300; outline:none; transition:border-color .2s; }
.add-input:focus { border-color:var(--border-h); }
.add-input::placeholder { color:var(--dim); }
.add-btn { background:var(--accent); color:#111; border:none; border-radius:8px; width:38px; height:38px; font-size:18px; cursor:pointer; transition:all .2s; display:flex; align-items:center; justify-content:center; flex-shrink:0; }
.add-btn:hover { background:#f0d48a; }
.add-meta { display:flex; gap:6px; flex-wrap:wrap; }
.pill { padding:4px 10px; border-radius:6px; border:1px solid var(--border); background:transparent; color:var(--muted); font-family:'DM Mono',monospace; font-size:10px; letter-spacing:.06em; cursor:pointer; transition:all .15s; }
.pill:hover { border-color:var(--border-h); color:var(--text); }
.pill.as-a { border-color:var(--red); color:var(--red); background:var(--red-d); }
.pill.as-s { border-color:var(--accent); color:var(--accent); background:var(--accent-d); }
.pill.as-b { border-color:#6b6560; color:#8a8580; background:rgba(74,72,69,.2); }
.pill.ae-p { border-color:var(--green); color:var(--green); background:var(--green-d); }
.pill.ae-m { border-color:var(--accent); color:var(--accent); background:var(--accent-d); }
.pill.ae-l { border-color:var(--red); color:var(--red); background:var(--red-d); }

/* Kanban */
.kanban { display:flex; gap:12px; padding:0 28px 40px; overflow-x:auto; align-items:flex-start; opacity:0; animation:fadeUp .5s ease .2s forwards; }
.kanban-col { flex:0 0 260px; background:var(--surface); border:1px solid var(--border); border-radius:12px; overflow:hidden; min-height:200px; transition:border-color .2s; }
.kanban-col.drag-over { border-color:var(--accent); background:rgba(232,200,122,.02); }
.col-header { display:flex; align-items:center; justify-content:space-between; padding:14px 16px 12px; border-bottom:1px solid var(--border); }
.col-title { font-size:10px; letter-spacing:.2em; text-transform:uppercase; font-weight:400; }
.col-count { font-size:10px; color:var(--dim); background:var(--surface2); padding:2px 7px; border-radius:10px; }
.col-body { padding:10px; min-height:100px; display:flex; flex-direction:column; gap:6px; }

/* Task card */
.task-card { background:var(--surface2); border:1px solid var(--border); border-radius:9px; padding:12px 13px; cursor:grab; transition:all .15s; user-select:none; }
.task-card:hover { border-color:var(--border-h); transform:translateY(-1px); box-shadow:0 4px 12px rgba(0,0,0,.3); }
.task-card.dragging { opacity:.3; cursor:grabbing; }
.drag-placeholder { border:1px dashed var(--accent); background:var(--accent-d); height:64px; border-radius:9px; }

.card-name { font-size:12px; color:var(--text); line-height:1.5; margin-bottom:8px; cursor:pointer; }
.card-name:hover { color:var(--accent); }

.card-due-tag { display:inline-flex; align-items:center; gap:4px; font-size:9px; padding:3px 8px; border-radius:20px; border:1px solid; margin-bottom:8px; }
.card-due-tag.normal { color:var(--muted); border-color:var(--border); }
.card-due-tag.soon { color:var(--accent); border-color:rgba(232,200,122,.4); background:var(--accent-d); }
.card-due-tag.overdue { color:var(--red); border-color:rgba(224,122,109,.4); background:var(--red-d); }

.card-footer { display:flex; align-items:center; justify-content:space-between; }
.card-badges { display:flex; gap:4px; }
.badge { font-size:9px; padding:2px 6px; border-radius:4px; border:1px solid; }
.badge-petit { color:var(--green); border-color:rgba(109,189,122,.3); }
.badge-moyen { color:var(--accent); border-color:rgba(232,200,122,.3); }
.badge-lourd { color:var(--red); border-color:rgba(224,122,109,.3); }

.card-actions { display:flex; gap:4px; margin-top:8px; }
.card-btn { flex:1; padding:4px 0; border-radius:5px; border:1px solid var(--border); background:transparent; color:var(--muted); font-family:'DM Mono',monospace; font-size:9px; cursor:pointer; transition:all .15s; letter-spacing:.06em; }
.card-btn:hover { color:var(--text); border-color:var(--border-h); }
.card-btn.del:hover { color:var(--red); border-color:rgba(224,122,109,.4); }

/* List view */
.list-view { padding:0 28px 40px; display:none; opacity:0; animation:fadeUp .5s ease .2s forwards; }
.list-group { margin-bottom:24px; }
.group-label { font-size:9px; letter-spacing:.2em; text-transform:uppercase; color:var(--muted); margin-bottom:8px; display:flex; align-items:center; gap:10px; }
.group-label::after { content:''; flex:1; height:1px; background:var(--border); }
.list-item { display:flex; align-items:center; gap:10px; padding:10px 12px; border-radius:8px; border:1px solid transparent; margin-bottom:3px; transition:all .15s; cursor:pointer; }
.list-item:hover { background:var(--surface); border-color:var(--border); }
.list-check { width:16px; height:16px; border-radius:4px; border:1px solid var(--border); flex-shrink:0; cursor:pointer; transition:all .15s; display:flex; align-items:center; justify-content:center; font-size:9px; }
.list-check:hover { border-color:var(--green); }
.list-check.done { background:var(--green); border-color:var(--green); color:#111; }
.list-name { flex:1; font-size:12px; color:var(--text); }
.list-name.done { text-decoration:line-through; color:var(--muted); }
.list-del { width:22px; height:22px; border-radius:5px; border:1px solid transparent; background:transparent; color:var(--dim); font-size:10px; cursor:pointer; transition:all .15s; display:flex; align-items:center; justify-content:center; opacity:0; }
.list-item:hover .list-del { opacity:1; }
.list-del:hover { border-color:rgba(224,122,109,.4); color:var(--red); }

/* Modal base */
.modal-overlay { position:fixed; inset:0; background:rgba(0,0,0,.75); backdrop-filter:blur(6px); z-index:100; display:flex; align-items:center; justify-content:center; padding:24px; opacity:0; pointer-events:none; transition:opacity .2s; }
.modal-overlay.open { opacity:1; pointer-events:all; }
.modal { background:var(--surface); border:1px solid var(--border); border-radius:16px; width:100%; padding:28px; transform:translateY(16px); transition:transform .25s ease; }
.modal-overlay.open .modal { transform:translateY(0); }
.modal-close { background:var(--surface2); border:1px solid var(--border); color:var(--muted); width:32px; height:32px; border-radius:8px; cursor:pointer; font-size:14px; display:flex; align-items:center; justify-content:center; flex-shrink:0; transition:all .15s; }
.modal-close:hover { color:var(--text); border-color:var(--border-h); }

/* Task modal */
#taskModal { max-width:480px; }
.modal-header { display:flex; align-items:flex-start; justify-content:space-between; margin-bottom:20px; gap:16px; }
.modal-title-input { flex:1; background:transparent; border:none; color:var(--text); font-family:'Instrument Serif',serif; font-size:22px; font-style:italic; outline:none; line-height:1.3; padding:0; }
.modal-title-input::placeholder { color:var(--dim); }
.modal-meta { display:flex; gap:8px; margin-bottom:20px; flex-wrap:wrap; }
.modal-label { font-size:9px; letter-spacing:.2em; text-transform:uppercase; color:var(--muted); margin-bottom:8px; }
.modal-field { margin-bottom:16px; }
.modal-textarea { width:100%; background:var(--surface2); border:1px solid var(--border); border-radius:8px; padding:12px 14px; color:var(--text); font-family:'DM Mono',monospace; font-size:12px; font-weight:300; line-height:1.7; resize:none; outline:none; min-height:90px; transition:border-color .2s; }
.modal-textarea:focus { border-color:var(--border-h); }
.modal-textarea::placeholder { color:var(--dim); }
.modal-footer { display:flex; justify-content:space-between; align-items:center; margin-top:20px; }
.modal-created { font-size:10px; color:var(--dim); }
.btn-save { background:var(--accent); color:#111; border:none; border-radius:8px; padding:10px 20px; font-family:'DM Mono',monospace; font-size:11px; letter-spacing:.1em; cursor:pointer; transition:all .2s; }
.btn-save:hover { background:#f0d48a; }

/* Custom date picker */
.date-picker-wrap { position:relative; }
.date-display { display:flex; align-items:center; gap:10px; background:var(--surface2); border:1px solid var(--border); border-radius:8px; padding:10px 14px; cursor:pointer; transition:border-color .2s; }
.date-display:hover { border-color:var(--border-h); }
.date-display-icon { font-size:14px; }
.date-display-text { font-size:12px; color:var(--text); flex:1; }
.date-display-text.empty { color:var(--dim); }
.date-display-clear { font-size:11px; color:var(--muted); padding:2px 6px; border-radius:4px; background:var(--surface3); cursor:pointer; }
.date-display-clear:hover { color:var(--red); }

.date-picker-popup { position:absolute; top:calc(100% + 8px); left:0; background:var(--surface); border:1px solid var(--border); border-radius:12px; padding:16px; z-index:200; box-shadow:0 12px 40px rgba(0,0,0,.5); min-width:260px; display:none; }
.date-picker-popup.open { display:block; }
.dp-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:14px; }
.dp-nav { background:transparent; border:1px solid var(--border); color:var(--muted); width:28px; height:28px; border-radius:6px; cursor:pointer; font-size:12px; display:flex; align-items:center; justify-content:center; transition:all .15s; }
.dp-nav:hover { border-color:var(--border-h); color:var(--text); }
.dp-month { font-size:12px; color:var(--text); letter-spacing:.06em; }
.dp-days-header { display:grid; grid-template-columns:repeat(7,1fr); gap:2px; margin-bottom:6px; }
.dp-day-name { font-size:9px; color:var(--muted); text-align:center; padding:4px 0; letter-spacing:.06em; }
.dp-days { display:grid; grid-template-columns:repeat(7,1fr); gap:2px; }
.dp-day { font-size:11px; color:var(--text); text-align:center; padding:6px 4px; border-radius:6px; cursor:pointer; transition:all .15s; border:1px solid transparent; }
.dp-day:hover { background:var(--surface2); border-color:var(--border); }
.dp-day.other-month { color:var(--dim); }
.dp-day.today { border-color:var(--border-h); }
.dp-day.selected { background:var(--accent); color:#111; border-color:var(--accent); }
.dp-day.past { color:var(--dim); }
.dp-day.empty { cursor:default; }
.dp-day.empty:hover { background:transparent; border-color:transparent; }

/* Stats modal */
#statsModal { max-width:560px; }
.stats-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:24px; }
.stats-title { font-family:'Instrument Serif',serif; font-size:22px; font-style:italic; color:var(--text); }
.stats-grid { display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:20px; }
.stat-card { background:var(--surface2); border:1px solid var(--border); border-radius:10px; padding:16px; }
.stat-label { font-size:9px; letter-spacing:.2em; text-transform:uppercase; color:var(--muted); margin-bottom:10px; }
.stat-value { font-family:'Instrument Serif',serif; font-size:32px; font-style:italic; color:var(--text); line-height:1; }
.stat-sub { font-size:10px; color:var(--muted); margin-top:4px; }
.stat-value.green { color:var(--green); }
.stat-value.accent { color:var(--accent); }

.stats-section { margin-bottom:20px; }
.stats-section-title { font-size:9px; letter-spacing:.2em; text-transform:uppercase; color:var(--muted); margin-bottom:12px; display:flex; align-items:center; gap:10px; }
.stats-section-title::after { content:''; flex:1; height:1px; background:var(--border); }

/* Effort bars */
.effort-bar-row { display:flex; align-items:center; gap:10px; margin-bottom:8px; }
.effort-bar-label { font-size:10px; color:var(--muted); width:60px; flex-shrink:0; }
.effort-bar-track { flex:1; height:6px; background:var(--surface3); border-radius:3px; overflow:hidden; }
.effort-bar-fill { height:100%; border-radius:3px; transition:width .6s ease; }
.effort-bar-count { font-size:10px; color:var(--dim); width:20px; text-align:right; flex-shrink:0; }

/* Week evolution */
.week-row { display:flex; align-items:center; gap:8px; margin-bottom:8px; }
.week-label { font-size:10px; color:var(--muted); width:80px; flex-shrink:0; }
.week-bar-track { flex:1; height:20px; background:var(--surface3); border-radius:5px; overflow:hidden; position:relative; }
.week-bar-fill { height:100%; border-radius:5px; background:var(--green); transition:width .6s ease; display:flex; align-items:center; padding-left:8px; }
.week-bar-fill span { font-size:9px; color:#111; font-weight:400; }
.week-bar-empty { font-size:9px; color:var(--dim); position:absolute; left:8px; top:50%; transform:translateY(-50%); }

/* Toast */
.toast { position:fixed; bottom:24px; left:50%; transform:translateX(-50%) translateY(80px); background:var(--surface); border:1px solid var(--border); color:var(--text); padding:9px 16px; border-radius:10px; font-size:11px; letter-spacing:.06em; z-index:300; transition:transform .3s cubic-bezier(.34,1.56,.64,1); white-space:nowrap; }
.toast.show { transform:translateX(-50%) translateY(0); }
.toast.success { border-color:rgba(109,189,122,.4); color:var(--green); }
.toast.error { border-color:rgba(224,122,109,.4); color:var(--red); }

@keyframes fadeUp { from{opacity:0;transform:translateY(10px)} to{opacity:1;transform:translateY(0)} }
</style>
</head>
<body>

<div class="toast" id="toast"></div>

<!-- Task modal -->
<div class="modal-overlay" id="taskModalOverlay" onclick="if(event.target===this)closeTaskModal()">
  <div class="modal" id="taskModal">
    <div class="modal-header">
      <input class="modal-title-input" id="modalTitle" placeholder="Nom de la tÃ¢che...">
      <button class="modal-close" onclick="closeTaskModal()">âœ•</button>
    </div>
    <div class="modal-meta" id="modalMeta"></div>
    <div class="modal-field">
      <div class="modal-label">Notes</div>
      <textarea class="modal-textarea" id="modalNotes" placeholder="Ajouter des notes..."></textarea>
    </div>
    <div class="modal-field">
      <div class="modal-label">Date d'Ã©chÃ©ance</div>
      <div class="date-picker-wrap">
        <div class="date-display" id="dateDisplay" onclick="toggleDatePicker()">
          <span class="date-display-icon">ðŸ“…</span>
          <span class="date-display-text empty" id="dateDisplayText">Aucune date</span>
          <span class="date-display-clear" id="dateClear" onclick="event.stopPropagation();clearDate()" style="display:none">âœ•</span>
        </div>
        <div class="date-picker-popup" id="datePickerPopup">
          <div class="dp-header">
            <button class="dp-nav" onclick="dpNav(-1)">â€¹</button>
            <div class="dp-month" id="dpMonth"></div>
            <button class="dp-nav" onclick="dpNav(1)">â€º</button>
          </div>
          <div class="dp-days-header">
            <div class="dp-day-name">L</div><div class="dp-day-name">M</div><div class="dp-day-name">M</div>
            <div class="dp-day-name">J</div><div class="dp-day-name">V</div><div class="dp-day-name">S</div>
            <div class="dp-day-name">D</div>
          </div>
          <div class="dp-days" id="dpDays"></div>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <div class="modal-created" id="modalCreated"></div>
      <button class="btn-save" onclick="saveModal()">Sauvegarder</button>
    </div>
  </div>
</div>

<!-- Stats modal -->
<div class="modal-overlay" id="statsModalOverlay" onclick="if(event.target===this)closeStats()">
  <div class="modal" id="statsModal">
    <div class="stats-header">
      <div class="stats-title">Statistiques</div>
      <button class="modal-close" onclick="closeStats()">âœ•</button>
    </div>
    <div class="stats-grid" id="statsGrid"></div>
    <div class="stats-section">
      <div class="stats-section-title">RÃ©partition par effort</div>
      <div id="effortBars"></div>
    </div>
    <div class="stats-section">
      <div class="stats-section-title">Ã‰volution (4 derniÃ¨res semaines)</div>
      <div id="weekBars"></div>
    </div>
  </div>
</div>

<!-- Header -->
<div class="header">
  <div class="title">To<em>do</em></div>
  <div class="header-right">
    <button class="icon-btn" onclick="openStats()" title="Statistiques">â—Ž</button>
    <div class="view-toggle">
      <button class="view-btn active" id="btnKanban" onclick="switchView('kanban')">Kanban</button>
      <button class="view-btn" id="btnList" onclick="switchView('list')">Liste</button>
    </div>
  </div>
</div>

<!-- Add form -->
<div class="add-form">
  <div class="add-input-row">
    <input class="add-input" id="taskInput" type="text" placeholder="Nouvelle tÃ¢che..." autocomplete="off">
    <button class="add-btn" onclick="addTask()">+</button>
  </div>
  <div class="add-meta">
    <button class="pill as-a" data-g="statut" data-v="Aujourd'hui" onclick="selectPill(this,'statut')">Aujourd'hui</button>
    <button class="pill" data-g="statut" data-v="Cette semaine" onclick="selectPill(this,'statut')">Semaine</button>
    <button class="pill" data-g="statut" data-v="Backlog" onclick="selectPill(this,'statut')">Backlog</button>
    <button class="pill" data-g="effort" data-v="Petit" onclick="selectPill(this,'effort')">Petit</button>
    <button class="pill ae-m" data-g="effort" data-v="Moyen" onclick="selectPill(this,'effort')">Moyen</button>
    <button class="pill" data-g="effort" data-v="Lourd" onclick="selectPill(this,'effort')">Lourd</button>
  </div>
</div>

<!-- Kanban -->
<div class="kanban" id="kanbanView"><div style="color:var(--muted);font-size:12px;padding:40px">Chargement...</div></div>

<!-- List -->
<div class="list-view" id="listView"></div>

<script>
// â”€â”€ Supabase â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const SB_URL = 'https://uupzcgtmjcwivpeiinqf.supabase.co';
const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV1cHpjZ3RtamN3aXZwZWlpbnFmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIyMDk3OTUsImV4cCI6MjA4Nzc4NTc5NX0.1gNomJJbUcvSbRYe-RG-mARBzpwo5UZh8ikSGrmwkGE';

async function sb(path, opts={}) {
  const res = await fetch(`${SB_URL}/rest/v1/${path}`, {
    ...opts,
    headers: { 'apikey':SB_KEY, 'Authorization':`Bearer ${SB_KEY}`, 'Content-Type':'application/json', 'Prefer':'return=representation', ...(opts.headers||{}) }
  });
  if (!res.ok) throw new Error(await res.text());
  const t = await res.text();
  return t ? JSON.parse(t) : null;
}

// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let tasks = [];
let currentView = 'kanban';
let selStatut = "Aujourd'hui";
let selEffort = 'Moyen';
let modalTaskId = null;
let dragId = null;
let placeholder = null;
let dpDate = null;
let dpCurrent = new Date();

const COLS = [
  { key:'Backlog',         label:'Backlog',        color:'var(--muted)' },
  { key:'Cette semaine',  label:'Cette semaine',  color:'var(--accent)' },
  { key:"Aujourd'hui",    label:"Aujourd'hui",    color:'var(--red)' },
  { key:'Fait',           label:'Fait âœ“',         color:'var(--green)' }
];

// â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('taskInput').addEventListener('keydown', e => { if(e.key==='Enter') addTask(); });
document.addEventListener('keydown', e => { if(e.key==='Escape'){closeTaskModal();closeStats();closeDatePicker();} });
document.addEventListener('click', e => {
  const popup = document.getElementById('datePickerPopup');
  const wrap = document.querySelector('.date-picker-wrap');
  if(popup.classList.contains('open') && !wrap.contains(e.target)) closeDatePicker();
});

fetchTasks();

async function fetchTasks() {
  try {
    tasks = await sb('todos?order=created_at.desc');
    render();
  } catch(e) { document.getElementById('kanbanView').innerHTML='<div style="color:var(--red);padding:40px;font-size:12px">Erreur de chargement</div>'; }
}

// â”€â”€ Render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function render() { currentView==='kanban' ? renderKanban() : renderList(); }

function renderKanban() {
  const view = document.getElementById('kanbanView');
  view.innerHTML = '';
  COLS.forEach(col => {
    const colTasks = tasks.filter(t => t.statut === col.key);
    const el = document.createElement('div');
    el.className = 'kanban-col';
    el.dataset.col = col.key;
    el.innerHTML = `
      <div class="col-header">
        <div class="col-title" style="color:${col.color}">${col.label}</div>
        <div class="col-count">${colTasks.length}</div>
      </div>
      <div class="col-body" id="col-${col.key.replace(/['\s]/g,'')}"></div>`;
    view.appendChild(el);
    const body = el.querySelector('.col-body');
    colTasks.forEach(t => body.appendChild(makeCard(t)));
    el.addEventListener('dragover', onDragOver);
    el.addEventListener('dragleave', onDragLeave);
    el.addEventListener('drop', e => onDrop(e, col.key));
  });
}

function makeCard(t) {
  const el = document.createElement('div');
  el.className = 'task-card';
  el.draggable = true;
  el.dataset.id = t.id;

  const now = new Date(); now.setHours(0,0,0,0);
  let dueHtml = '';
  if (t.due_date) {
    const due = new Date(t.due_date + 'T12:00:00');
    const diff = Math.ceil((due - now) / 86400000);
    let cls = 'normal', label = '';
    if (diff < 0) { cls='overdue'; label=`En retard de ${Math.abs(diff)}j`; }
    else if (diff === 0) { cls='soon'; label='Aujourd\'hui'; }
    else if (diff === 1) { cls='soon'; label='Demain'; }
    else if (diff <= 3) { cls='soon'; label=`Dans ${diff}j`; }
    else { label = due.toLocaleDateString('fr-FR',{day:'numeric',month:'short'}); }
    dueHtml = `<div class="card-due-tag ${cls}">ðŸ“… ${label}</div>`;
  }

  const effortClass = t.effort ? `badge-${t.effort.toLowerCase()}` : '';
  el.innerHTML = `
    <div class="card-name" onclick="openModal('${t.id}')">${t.name}</div>
    ${dueHtml}
    <div class="card-footer">
      <div class="card-badges">${t.effort ? `<span class="badge ${effortClass}">${t.effort}</span>` : ''}</div>
    </div>
    <div class="card-actions">
      <button class="card-btn" onclick="openModal('${t.id}')">dÃ©tail</button>
      <button class="card-btn del" onclick="deleteTask('${t.id}')">supprimer</button>
    </div>`;
  el.addEventListener('dragstart', e => onDragStart(e, t.id));
  el.addEventListener('dragend', onDragEnd);
  return el;
}

function renderList() {
  const view = document.getElementById('listView');
  view.innerHTML = '';
  const order = ['Backlog', 'Cette semaine', "Aujourd'hui", 'Fait'];
  order.forEach(statut => {
    const group = tasks.filter(t => t.statut === statut);
    if (!group.length) return;
    const div = document.createElement('div');
    div.className = 'list-group';
    const label = statut === 'Fait' ? 'Fait âœ“' : statut;
    div.innerHTML = `<div class="group-label">${label} <span style="color:var(--dim)">${group.length}</span></div>`;
    group.forEach(t => {
      const item = document.createElement('div');
      item.className = 'list-item';
      const done = t.statut === 'Fait';
      item.innerHTML = `
        <div class="list-check ${done?'done':''}" onclick="event.stopPropagation();toggleDone('${t.id}')">${done?'âœ“':''}</div>
        <div class="list-name ${done?'done':''}">${t.name}</div>
        <button class="list-del" onclick="event.stopPropagation();deleteTask('${t.id}')">âœ•</button>`;
      item.addEventListener('click', () => openModal(t.id));
      div.appendChild(item);
    });
    view.appendChild(div);
  });
  if (!view.innerHTML) view.innerHTML = `<div style="text-align:center;padding:60px;color:var(--muted);font-size:12px">Aucune tÃ¢che ðŸŒ¿</div>`;
}

// â”€â”€ Drag & drop â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function onDragStart(e, id) { dragId=id; e.dataTransfer.effectAllowed='move'; setTimeout(()=>e.target.classList.add('dragging'),0); }
function onDragEnd(e) { e.target.classList.remove('dragging'); if(placeholder){placeholder.remove();placeholder=null;} document.querySelectorAll('.kanban-col').forEach(c=>c.classList.remove('drag-over')); }
function onDragOver(e) {
  e.preventDefault();
  const col = e.currentTarget;
  col.classList.add('drag-over');
  const body = col.querySelector('.col-body');
  if (!placeholder) { placeholder=document.createElement('div'); placeholder.className='drag-placeholder'; }
  const after = getDragAfter(body, e.clientY);
  if (!after) body.appendChild(placeholder); else body.insertBefore(placeholder, after);
}
function onDragLeave(e) { if(!e.currentTarget.contains(e.relatedTarget)) e.currentTarget.classList.remove('drag-over'); }
async function onDrop(e, newStatut) {
  e.preventDefault();
  e.currentTarget.classList.remove('drag-over');
  if (!dragId) return;
  const task = tasks.find(t=>t.id===dragId);
  if (task && task.statut !== newStatut) {
    task.statut = newStatut;
    renderKanban();
    try { await sb(`todos?id=eq.${dragId}`,{method:'PATCH',body:JSON.stringify({statut:newStatut})}); }
    catch(e) { fetchTasks(); }
  }
  dragId = null;
}
function getDragAfter(container, y) {
  return [...container.querySelectorAll('.task-card:not(.dragging)')].reduce((closest, el) => {
    const box = el.getBoundingClientRect();
    const offset = y - box.top - box.height/2;
    if (offset < 0 && offset > closest.offset) return {offset, el};
    return closest;
  }, {offset:Number.NEGATIVE_INFINITY}).el;
}

// â”€â”€ CRUD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function addTask() {
  const input = document.getElementById('taskInput');
  const name = input.value.trim();
  if (!name) return;
  input.value = '';
  try {
    const created = await sb('todos',{method:'POST',body:JSON.stringify({name,statut:selStatut,effort:selEffort,notes:''})});
    tasks.unshift(created[0]);
    render();
    showToast('TÃ¢che ajoutÃ©e âœ“','success');
  } catch(e) { showToast('Erreur','error'); }
}

async function toggleDone(id) {
  const t = tasks.find(t=>t.id===id);
  if (!t) return;
  const n = t.statut==='Fait' ? "Aujourd'hui" : 'Fait';
  t.statut = n; render();
  try { await sb(`todos?id=eq.${id}`,{method:'PATCH',body:JSON.stringify({statut:n})}); }
  catch(e) { fetchTasks(); }
}

async function deleteTask(id) {
  tasks = tasks.filter(t=>t.id!==id);
  render();
  showToast('SupprimÃ©e','success');
  try { await sb(`todos?id=eq.${id}`,{method:'DELETE',headers:{'Prefer':''}}); }
  catch(e) { fetchTasks(); }
}

// â”€â”€ Task modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openModal(id) {
  const t = tasks.find(t=>t.id===id);
  if (!t) return;
  modalTaskId = id;
  document.getElementById('modalTitle').value = t.name;
  document.getElementById('modalNotes').value = t.notes||'';
  document.getElementById('modalCreated').textContent = 'CrÃ©Ã©e le ' + fmtDate(t.created_at);
  setDpDate(t.due_date || null);

  const sc = t.statut==="Aujourd'hui"?'var(--red)':t.statut==='Cette semaine'?'var(--accent)':t.statut==='Fait'?'var(--green)':'var(--muted)';
  const ec = t.effort==='Petit'?'var(--green)':t.effort==='Lourd'?'var(--red)':'var(--accent)';
  document.getElementById('modalMeta').innerHTML = `
    <span style="font-size:10px;padding:4px 10px;border-radius:6px;border:1px solid ${sc};color:${sc};background:${sc}18">${t.statut}</span>
    ${t.effort?`<span style="font-size:10px;padding:4px 10px;border-radius:6px;border:1px solid ${ec};color:${ec};background:${ec}18">${t.effort}</span>`:''}`;
  document.getElementById('taskModalOverlay').classList.add('open');
}

function closeTaskModal() {
  document.getElementById('taskModalOverlay').classList.remove('open');
  closeDatePicker();
  modalTaskId = null;
}

async function saveModal() {
  if (!modalTaskId) return;
  const name = document.getElementById('modalTitle').value.trim();
  const notes = document.getElementById('modalNotes').value;
  const due_date = dpDate || null;
  if (!name) return;
  const t = tasks.find(t=>t.id===modalTaskId);
  if (t) { t.name=name; t.notes=notes; t.due_date=due_date; }
  closeTaskModal(); render();
  showToast('SauvegardÃ© âœ“','success');
  try { await sb(`todos?id=eq.${modalTaskId}`,{method:'PATCH',body:JSON.stringify({name,notes,due_date})}); }
  catch(e) { fetchTasks(); }
}

// â”€â”€ Custom date picker â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setDpDate(val) {
  dpDate = val;
  const txt = document.getElementById('dateDisplayText');
  const clr = document.getElementById('dateClear');
  if (val) {
    txt.textContent = new Date(val+'T12:00:00').toLocaleDateString('fr-FR',{weekday:'long',day:'numeric',month:'long'});
    txt.classList.remove('empty');
    clr.style.display = 'inline';
  } else {
    txt.textContent = 'Aucune date';
    txt.classList.add('empty');
    clr.style.display = 'none';
  }
  if (val) dpCurrent = new Date(val+'T12:00:00');
  renderDp();
}

function clearDate() { setDpDate(null); }

function toggleDatePicker() {
  const popup = document.getElementById('datePickerPopup');
  popup.classList.toggle('open');
  if (popup.classList.contains('open')) renderDp();
}

function closeDatePicker() { document.getElementById('datePickerPopup').classList.remove('open'); }

function dpNav(dir) {
  dpCurrent = new Date(dpCurrent.getFullYear(), dpCurrent.getMonth()+dir, 1);
  renderDp();
}

function renderDp() {
  const year = dpCurrent.getFullYear();
  const month = dpCurrent.getMonth();
  document.getElementById('dpMonth').textContent =
    new Date(year,month,1).toLocaleDateString('fr-FR',{month:'long',year:'numeric'});

  const today = new Date(); today.setHours(0,0,0,0);
  const first = new Date(year,month,1);
  const last = new Date(year,month+1,0);
  let startDay = first.getDay(); // 0=Sun
  startDay = startDay === 0 ? 6 : startDay - 1; // Mon=0

  const days = document.getElementById('dpDays');
  days.innerHTML = '';

  for (let i=0; i<startDay; i++) {
    const el = document.createElement('div');
    el.className = 'dp-day empty';
    days.appendChild(el);
  }

  for (let d=1; d<=last.getDate(); d++) {
    const el = document.createElement('div');
    el.className = 'dp-day';
    el.textContent = d;
    const thisDate = new Date(year,month,d);
    const iso = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    if (thisDate < today) el.classList.add('past');
    if (thisDate.getTime()===today.getTime()) el.classList.add('today');
    if (dpDate===iso) el.classList.add('selected');
    el.addEventListener('click', ()=>{ setDpDate(iso); closeDatePicker(); });
    days.appendChild(el);
  }
}

// â”€â”€ Stats modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openStats() {
  buildStats();
  document.getElementById('statsModalOverlay').classList.add('open');
}
function closeStats() { document.getElementById('statsModalOverlay').classList.remove('open'); }

function buildStats() {
  const now = new Date();
  const startOfWeek = new Date(now);
  startOfWeek.setDate(now.getDate() - now.getDay() + (now.getDay()===0?-6:1));
  startOfWeek.setHours(0,0,0,0);

  const active = tasks.filter(t=>t.statut!=='Fait');
  const done = tasks.filter(t=>t.statut==='Fait');
  const doneThisWeek = done.filter(t => new Date(t.created_at) >= startOfWeek);
  const total = tasks.length;
  const rate = total ? Math.round(done.length/total*100) : 0;

  // Grid
  document.getElementById('statsGrid').innerHTML = `
    <div class="stat-card">
      <div class="stat-label">ComplÃ©tÃ©es cette semaine</div>
      <div class="stat-value green">${doneThisWeek.length}</div>
      <div class="stat-sub">${done.length} au total</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Taux de complÃ©tion</div>
      <div class="stat-value accent">${rate}%</div>
      <div class="stat-sub">${active.length} en cours</div>
    </div>`;

  // Effort bars
  const efforts = ['Petit','Moyen','Lourd'];
  const effortColors = {'Petit':'var(--green)','Moyen':'var(--accent)','Lourd':'var(--red)'};
  const effortCounts = {};
  efforts.forEach(e => effortCounts[e] = active.filter(t=>t.effort===e).length);
  const maxE = Math.max(...Object.values(effortCounts), 1);
  document.getElementById('effortBars').innerHTML = efforts.map(e => `
    <div class="effort-bar-row">
      <div class="effort-bar-label">${e}</div>
      <div class="effort-bar-track">
        <div class="effort-bar-fill" style="width:${effortCounts[e]/maxE*100}%;background:${effortColors[e]}"></div>
      </div>
      <div class="effort-bar-count">${effortCounts[e]}</div>
    </div>`).join('');

  // Week evolution (4 semaines)
  const weeks = [];
  for (let w=3; w>=0; w--) {
    const start = new Date(startOfWeek);
    start.setDate(start.getDate() - w*7);
    const end = new Date(start);
    end.setDate(end.getDate() + 7);
    const label = w===0 ? 'Cette sem.' : w===1 ? 'Sem. dern.' :
      start.toLocaleDateString('fr-FR',{day:'numeric',month:'short'});
    const count = done.filter(t => {
      const d = new Date(t.created_at);
      return d >= start && d < end;
    }).length;
    weeks.push({label, count});
  }
  const maxW = Math.max(...weeks.map(w=>w.count), 1);
  document.getElementById('weekBars').innerHTML = weeks.map(w => `
    <div class="week-row">
      <div class="week-label">${w.label}</div>
      <div class="week-bar-track">
        ${w.count > 0
          ? `<div class="week-bar-fill" style="width:${w.count/maxW*100}%"><span>${w.count}</span></div>`
          : `<span class="week-bar-empty">0</span>`}
      </div>
    </div>`).join('');
}

// â”€â”€ View switch â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function switchView(view) {
  currentView = view;
  document.getElementById('kanbanView').style.display = view==='kanban'?'flex':'none';
  document.getElementById('listView').style.display = view==='list'?'block':'none';
  document.getElementById('btnKanban').classList.toggle('active', view==='kanban');
  document.getElementById('btnList').classList.toggle('active', view==='list');
  render();
}

// â”€â”€ Pills â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function selectPill(el, group) {
  document.querySelectorAll(`[data-g="${group}"]`).forEach(p=>p.className='pill');
  const v = el.dataset.v;
  if (group==='statut') {
    selStatut = v;
    el.classList.add(v==="Aujourd'hui"?'as-a':v==='Cette semaine'?'as-s':'as-b');
  } else {
    selEffort = v;
    el.classList.add(v==='Petit'?'ae-p':v==='Moyen'?'ae-m':'ae-l');
  }
}

// â”€â”€ Utils â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function fmtDate(d) {
  if (!d) return '';
  return new Date(d+(d.includes('T')?'':'T12:00:00')).toLocaleDateString('fr-FR',{day:'numeric',month:'short',year:'numeric'});
}

function showToast(msg, type='') {
  const t = document.getElementById('toast');
  t.textContent = msg; t.className='toast '+type; t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'), 2500);
}
</script>
</body>
</html>
